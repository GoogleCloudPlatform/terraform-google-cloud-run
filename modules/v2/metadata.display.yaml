# Copyright 2024 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: blueprints.cloud.google.com/v1alpha1
kind: BlueprintMetadata
metadata:
  name: terraform-google-cloud-run-v-2-display
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  info:
    title: Cloud Run v2 Service
    source:
      repo: https://github.com/GoogleCloudPlatform/terraform-google-cloud-run.git
      sourceType: git
      dir: /modules/v2
  ui:
    input:
      variables:
        binary_authorization:
          name: binary_authorization
          title: Binary Authorization
        client:
          name: client
          title: Client
        cloud_run_deletion_protection:
          name: cloud_run_deletion_protection
          title: Cloud Run Deletion Protection
          level: 1
          altDefaults:
            - type: ALTERNATE_TYPE_DC
              value: false
        containers:
          name: containers
          title: Containers
          properties:
            container_image:
              name: container_image
              title: Container Image
              regexValidation: ^((([a-zA-Z0-9]+(-[a-zA-Z0-9]+)*\.)+[a-zA-Z]{2,}(:[0-9]+)?/)?([a-z0-9]+([._-][a-z0-9]+)*/)*[a-z0-9]+([._-][a-z0-9]+)*(:(\w[\w.-]{0,127})|@sha256:[a-fA-F0-9]{64})?)$
              validation: Must be a valid Docker image (lowercase repo, optional registry, tag, or SHA256 digest)
            container_name:
              name: container_name
              title: Container Name
              regexValidation: ^[a-z0-9][a-z0-9_.-]{0,62}$
              validation: Container name must start and end with a lowercase alphanumeric character, contain only lowercase alphanumeric characters, hyphens or periods and must be less than 64 characters.
            working_dir:
              name: working_dir
              title: Working Dir
              regexValidation: "^(/[^/ ]+)*/?$"
              validation: Must be an absolute path (e.g., /app/src).
            volume_mounts:
              name: volume_mounts
              title: Volume Mounts
              subtext: Mount In-memory, Network File System, Secret and Cloud Storage bucket volumes to your container
              properties:
                name:
                  name: name
                  title: Name
                  regexValidation: ^[a-z0-9][a-z0-9_.-]{0,253}[a-z0-9]$
                  validation: Volume mount name must only contain alphanumeric characters, hyphens and underscores.
                mount_path:
                  name: mount_path
                  title: Mount Path
                  regexValidation: "^(/[^/ ]+)*/?$"
                  validation: Mount path must be an absolute path (e.g., /mnt/data).
            resources:
              name: resources
              title: Resources
              properties:
                limits:
                  name: limits
                  title: Limits
                  properties:
                    cpu:
                      name: cpu
                      title: CPU
                      subtext: Number of vCPUs allocated to each instance of this container
                      enumValueLabels:
                      - label: "1"
                        value: "1"
                      - label: "2"
                        value: "2"
                      - label: "3"
                        value: "3"
                      - label: "4"
                        value: "4"
                    memory:
                      name: memory
                      title: Memory
                      subtext: Memory to allocate to each instance of this container
                      regexValidation: ^[0-9]+(Mi|Gi|M|G)$
                      validation: Must be a valid memory size with unit, such as Mi, Gi, M, or G
                    nvidia_gpu:
                      name: nvidia_gpu
                      title: Nvidia GPU
                      regexValidation: ^[0-9]+$
                      validation: Must be a whole number representing the number of GPUs.
            startup_probe:
              name: startup_probe
              title: Startup Probe
              properties:
                failure_threshold:
                  name: failure_threshold
                  title: Failure Threshold
                  subtext: Number of times to retry the probe before marking the container as Unready
                  min: 1
                  max: 2147483647
                  validation: Choose an integer value between 1 and 2147483647
                initial_delay_seconds:
                  name: initial_delay_seconds
                  title: Initial Delay Seconds
                  subtext: Number of seconds after the container has started before performing the first probe. Enter an integer value between 0 and 240
                  min: 0
                  max: 240
                  validation: Enter an integer value between 0 and 240
                timeout_seconds:
                  name: timeout_seconds
                  title: Timeout Seconds
                  subtext: Number of seconds after which the probe times out. This value shouldn't exceed Period seconds. Enter an integer value between 1 and 240
                  min: 1
                  max: 240
                  validation: Enter an integer value between 1 and 240
                period_seconds:
                  name: period_seconds
                  title: Period Seconds
                  subtext: Number of seconds to wait between starting a probe attempt. Enter an integer value between 1 and 240
                  min: 1
                  max: 240
                  validation: Enter an integer value between 1 and 240
                http_get:
                  name: http_get
                  title: Http Get
                  properties:
                    path:
                      name: path
                      title: Path
                      subtext: "Path to access on the HTTP server. Ex: e.g./reddy"
                      regexValidation: "^(/[^/ ]+)*/?$"
                      validation: Path must be a valid URL path (e.g., /health).
                    port:
                      name: port
                      title: Port
                      subtext: Port to make a connection for the Cloud Run instance. It will default to the container port, whose default value is 8080
                    http_headers:
                      name: http_headers
                      title: Http Headers
                      subtext: Custom headers to set in the request. HTTP allows repeated headers
                      properties:
                        name:
                          name: name
                          title: Name
                          regexValidation: ^[A-Za-z][A-Za-z0-9-]{0,62}$
                          validation: "Must be a valid HTTP header name: start with a letter, contain only letters [A–Z, a–z], digits [0–9], or hyphens [-], and be at most 63 characters long"
                        value:
                          name: value
                          title: Value
                          regexValidation: ^.*$
                          validation: Must be a valid string
                tcp_socket:
                  name: tcp_socket
                  title: TCP Socket
                  subtext: Port to make a connection for the Cloud Run instance. It will default to the container port, whose default value is 8080
                  properties:
                    port:
                      name: port
                      title: Port
                      min: 1
                      max: 65535
                      validation: Port number must be between 1 and 65535.
                grpc:
                  name: grpc
                  title: GRPC
                  properties:
                    port:
                      name: port
                      title: Port
                      subtext: Port to make a connection for the Cloud Run instance. It will default to the container port, whose default value is 8080
                      min: 1
                      max: 65535
                      validation: Port number must be between 1 and 65535.
            liveness_probe:
              name: liveness_probe
              title: Liveness Probe
              properties:
                failure_threshold:
                  name: failure_threshold
                  title: Failure Threshold
                  subtext: Minimum consecutive failures for the probe to be considered failed after having succeeded. Minimum value is 1.
                  min: 1
                  max: 2147483647
                  validation: Choose an integer value between 1 and 2147483647
                initial_delay_seconds:
                  name: initial_delay_seconds
                  title: Initial Delay Seconds
                  subtext: Number of times to retry the probe before marking the container as Unready
                  min: 0
                  max: 3600
                  validation: Enter an integer value between 0 and 3600
                timeout_seconds:
                  name: timeout_seconds
                  title: Timeout Seconds
                  subtext: Number of times to retry the probe before marking the container as Unready
                  min: 1
                  max: 3600
                  validation: Enter an integer value between 1 and 3600
                period_seconds:
                  name: period_seconds
                  title: Period Seconds
                  subtext: Number of seconds to wait between starting a probe attempt. Enter an integer value between 1 and 3600
                  min: 1
                  max: 3600
                  validation: Enter an integer value between 1 and 3600
                http_get:
                  name: http_get
                  title: Http Get
                  properties:
                    path:
                      name: path
                      title: Path
                      subtext: Path to access on HTTP server
                      regexValidation: "^(/[^/ ]+)*/?$"
                      validation: Path must be a valid URL path (e.g., /health).
                    port:
                      name: port
                      title: Port
                      subtext: Port to make connection for the Cloud Run instance. It will default to container port which is 8080
                    http_headers:
                      name: http_headers
                      title: Http Headers
                      subtext: Custom Headers to set in the request. HTTP allows repeated headers.
                      properties:
                        name:
                          name: name
                          title: Name
                          regexValidation: ^[A-Za-z][A-Za-z0-9-]{0,62}$
                          validation: "Must be a valid HTTP header name: start with a letter, contain only letters [A–Z, a–z], digits [0–9], or hyphens [-], and be at most 63 characters long"
                        value:
                          name: value
                          title: Value
                          regexValidation: ^.*$
                          validation: Header value can be any string
                tcp_socket:
                  name: tcp_socket
                  title: TCP Socket
                  subtext: Port to make a connection for the Cloud Run instance. It will default to the container port, whose default value is 8080
                  properties:
                    port:
                      name: port
                      title: Port
                      min: 1
                      max: 65535
                      validation: Port number must be between 1 and 65535.
                grpc:
                  name: grpc
                  title: GRPC
                  properties:
                    port:
                      name: port
                      title: Port
                      subtext: Port to make a connection for the Cloud Run instance. It will default to the container port, whose default value is 8080
                      min: 1
                      max: 65535
                      validation: Port number must be between 1 and 65535.
            ports:
              name: ports
              title: Ports
              properties:
                name:
                  name: name
                  title: Name
                  regexValidation: ^[a-z0-9.-]*$
                  validation: Name may contain lowercase letters, numbers, hyphens or dots
                container_port:
                  name: container_port
                  title: Container Port
                  subtext: Requests will be sent to the container on this port
                  min: 1
                  max: 65535
                  validation: Choose an integer value between 1 and 65535
          altDefaults:
            - type: ALTERNATE_TYPE_DC
              value:
                - container_name: service-container
                  container_image: us-docker.pkg.dev/cloudrun/container/hello
                  ports:
                    container_port: 8080
        create_service_account:
          name: create_service_account
          title: Create Service Account
          level: 1
        custom_audiences:
          name: custom_audiences
          title: Custom Audiences
          regexValidation: "^https?://(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?.)+[A-Za-z]{2,}(?:/[^s]*)?$"
          validation: Custom audience must be a valid URL starting with 'http://' or 'https://'
        description:
          name: description
          title: Description
          level: 1
          regexValidation: ^[\s\S]{0,512}$
          validation: This field currently has a 512-character limit.
        enable_prometheus_sidecar:
          name: enable_prometheus_sidecar
          title: Enable Prometheus Sidecar
          level: 1
          altDefaults:
            - type: ALTERNATE_TYPE_DC
              value: true
        encryption_key:
          name: encryption_key
          title: Encryption Key
          level: 1
          regexValidation: "^projects/[A-Za-z0-9_-]+/locations/[A-Za-z0-9_-]+/keyRings/[A-Za-z0-9_-]+/cryptoKeys/[A-Za-z0-9_-]+$"
          validation: Encryption key must be in the format projects/{project}/locations/{location}/keyRings/{key_ring}/cryptoKeys/{key}.
        execution_environment:
          name: execution_environment
          title: Execution Environment
          level: 1
          enumValueLabels:
            - label: EXECUTION_ENVIRONMENT_GEN2
              value: EXECUTION_ENVIRONMENT_GEN2
            - label: EXECUTION_ENVIRONMENT_GEN1
              value: EXECUTION_ENVIRONMENT_GEN1
        iap_members:
          name: iap_members
          title: Iap Members
          level: 1
          regexValidation: ^(?:allUsers|allAuthenticatedUsers)$|^((?:user|group|serviceAccount):(?:[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})|(?:domain:(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,})|(?:projectOwner|projectEditor|projectViewer):[a-z][a-z0-9-]{0,28}[a-z0-9])$
          validation: Must be allUsers, allAuthenticatedUsers, or a service account in the format serviceAccount:email@example.com. [More info](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/iap_web_cloud_run_service_iam#member\/members-2).
        ingress:
          name: ingress
          title: Ingress
          level: 1
          enumValueLabels:
            - label: INGRESS_TRAFFIC_ALL
              value: INGRESS_TRAFFIC_ALL
            - label: INGRESS_TRAFFIC_INTERNAL_ONLY
              value: INGRESS_TRAFFIC_INTERNAL_ONLY
            - label: INGRESS_TRAFFIC_INTERNAL_LOAD_BALANCER
              value: INGRESS_TRAFFIC_INTERNAL_LOAD_BALANCER
        launch_stage:
          name: launch_stage
          title: Launch Stage
          enumValueLabels:
            - label: UNIMPLEMENTED
              value: UNIMPLEMENTED
            - label: PRELAUNCH
              value: PRELAUNCH
            - label: EARLY_ACCESS
              value: EARLY_ACCESS
            - label: ALPHA
              value: ALPHA
            - label: BETA
              value: BETA
            - label: GA
              value: GA
            - label: DEPRECATED
              value: DEPRECATED
        location:
          name: location
          title: Location
        max_instance_request_concurrency:
          name: max_instance_request_concurrency
          title: Max Instance Request Concurrency
          level: 1
          regexValidation: ^([1-9][0-9]{0,2}|1000)$
          validation: Max instance request concurrency must be an integer between 1 and 1000.
        members:
          name: members
          title: Members
          regexValidation: ^(?:allUsers|allAuthenticatedUsers)$|^((?:user|group|serviceAccount):(?:[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})|(?:domain:(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,})|(?:projectOwner|projectEditor|projectViewer):[a-z][a-z0-9-]{0,28}[a-z0-9])$
          validation: Must be allUsers, allAuthenticatedUsers, or a service account in the format serviceAccount:email@example.com. [More info](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/cloud_run_v2_service_iam#member\/members-1).
          level: 1
        project_id:
          name: project_id
          title: Project Id
        revision:
          name: revision
          title: Revision
          level: 1
          regexValidation: ^[a-z]([a-z0-9-]{0,61}[a-z0-9])?$
          validation: Revision name must use only lowercase letters, numbers and '-'. Must begin with a letter and cannot end with a '-'
        service_account:
          name: service_account
          title: Service Account
          regexValidation: ^[a-z][a-z0-9-]{4,29}@[a-z][a-z0-9-]{4,29}\.iam\.gserviceaccount\.com$
          validation: Service account email must be in the format {account-id}@{project-id}.iam.gserviceaccount.com.
        service_account_project_roles:
          name: service_account_project_roles
          title: Service Account Project Roles
          level: 1
          regexValidation: "^(?:[a-z][a-z0-9-]{4,29}/)?roles/[a-zA-Z0-9_.]+$"
          validation: Role must be in the format roles/{role_name}.
        service_annotations:
          name: service_annotations
          title: Service Annotations
        service_labels:
          name: service_labels
          title: Service Labels
        service_name:
          name: service_name
          title: Service Name
          regexValidation: ^[a-z][a-z0-9-]{0,47}[a-z0-9]$
          validation: Use lowercase letters, numbers, and hyphens. Start with a letter and end with letter/number. Must be 49 characters or fewer.
        service_scaling:
          name: service_scaling
          title: Service Scaling
          level: 1
          properties:
            min_instance_count:
              name: min_instance_count
              title: Min Instance Count
              subtext: The service minimum instances is preferable for most use-cases. Only use this setting if you specifically require a per-revision setting
          altDefaults:
            - type: ALTERNATE_TYPE_DC
              value:
                min_instance_count: 0
        session_affinity:
          name: session_affinity
          title: Session Affinity
          level: 1
          enumValueLabels:
            - label: "true"
              value: "true"
            - label: "false"
              value: "false"
        template_annotations:
          name: template_annotations
          title: Template Annotations
        template_labels:
          name: template_labels
          title: Template Labels
        template_scaling:
          name: template_scaling
          title: Template Scaling
          level: 1
          properties:
            min_instance_count:
              name: min_instance_count
              title: Min Instance Count
              subtext: The service minimum instances is preferable for most use-cases. Only use this setting if you specifically require a per-revision setting
            max_instance_count:
              name: max_instance_count
              title: Max Instance Count
              min: 1
          altDefaults:
            - type: ALTERNATE_TYPE_DC
              value:
                min_instance_count: 0
        timeout:
          name: timeout
          title: Timeout
          regexValidation: ^[0-9]+(?:\.[0-9]{1,9})?s$
          validation: Timeout must be a duration in seconds, ending with 's' (e.g., 300s or 1.5s).
        traffic:
          name: traffic
          title: Traffic
          properties:
            type:
              name: type
              title: Type
              enumValueLabels:
                - label: TRAFFIC_TARGET_ALLOCATION_TYPE_LATEST
                  value: TRAFFIC_TARGET_ALLOCATION_TYPE_LATEST
                - label: TRAFFIC_TARGET_ALLOCATION_TYPE_REVISION
                  value: TRAFFIC_TARGET_ALLOCATION_TYPE_REVISION
            percent:
              name: percent
              title: Percent
              min: 0
              max: 100
              validation: Percent must be an integer between 0 and 100.
            revision:
              name: revision
              title: Revision
              regexValidation: ^[a-z]([a-z0-9-]{0,61}[a-z0-9])?$
              validation: Revision name must use only lowercase letters, numbers and '-'. Must begin with a letter and cannot end with a '-'
            tag:
              name: tag
              title: Tag
              regexValidation: ^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$
              validation: Tag must start and end with a lowercase alphanumeric character, and contain only lowercase alphanumeric characters or hyphens.
        volumes:
          name: volumes
          title: Volumes
          subtext: After creating a volume, navigate to the Container’s section to mount it to a container
          properties:
            name:
              name: name
              title: Name
              regexValidation: ^[a-zA-Z0-9_-]*$
              validation: Volume name must only contain alphanumeric characters, hyphens and underscores
            secret:
              name: secret
              title: Secret
              properties:
                secret:
                  name: secret
                  title: Secret
                  regexValidation: ^([a-zA-Z0-9-_]{1,255}|projects\/([a-z][a-z0-9-]{4,28}[a-z0-9]|[0-9]{6,})\/secrets\/[a-zA-Z0-9-_]{1,255})$
                  validation: Secret name must be either the secret name or the full Secret Manager resource path.
                default_mode:
                  name: default_mode
                  title: Default Mode
                  regexValidation: ^(0[0-7]{3})$
                  validation: Must be a value between 0000 and 0777 (octal).
                items:
                  name: items
                  title: Items
                  properties:
                    path:
                      name: path
                      title: Path
                      subtext: "Example format (parent secret): \"projects/project-number/secrets/secret-name\""
                      regexValidation: "^(.{1,2}/)?([A-Za-z0-9_.-]+/)*[A-Za-z0-9_.-]+$"
                      validation: Path must be a valid relative file path.
                    version:
                      name: version
                      title: Version
                      regexValidation: ^(latest|[1-9][0-9]*)$
                      validation: Version must be 'latest' or a version number.
                    mode:
                      name: mode
                      title: Mode
                      regexValidation: ^(0|0[1-7]{1,3})?$
                      validation: Must be a value between 01 and 0777 (octal)
            cloud_sql_instance:
              name: cloud_sql_instance
              title: Cloud SQL Instance
              properties:
                instances:
                  name: instances
                  title: Instances
            empty_dir:
              name: empty_dir
              title: Empty Dir
              properties:
                medium:
                  name: medium
                  title: Medium
                  enumValueLabels:
                    - label: MEMORY
                      value: MEMORY
            gcs:
              name: gcs
              title: GCS
              properties:
                bucket:
                  name: bucket
                  title: Bucket
                  regexValidation: ^[a-z0-9](?:[a-z0-9.-]{1,61}[a-z0-9])$
                  validation: Bucket name must be lowercase, start and end with an alphanumeric character, and contain only alphanumeric characters, dashes, and dots.
                read_only:
                  name: read_only
                  title: Read Only
                  enumValueLabels:
                    - label: "true"
                      value: "true"
                    - label: "false"
                      value: "false"
            nfs:
              name: nfs
              title: NFS
              properties:
                server:
                  name: server
                  title: Server
                  subtext: The IP address or hostname of your NFS server
                  regexValidation: "^(([a-zA-Z0-9]([-a-zA-Z0-9]*[a-zA-Z0-9])?.)*[a-zA-Z]{2,}|([0-9]{1,3}.){3}[0-9]{1,3})$"
                  validation: Must be a valid IP address or hostname.
                path:
                  name: path
                  title: Path
                  subtext: The path to the NFS server directory you want to mount
                  regexValidation: "^(/[^/ ]+)*/?$"
                  validation: Path must be an absolute path (e.g., /exports/data).
                read_only:
                  name: read_only
                  title: Read Only
                  enumValueLabels:
                    - label: "true"
                      value: "true"
                    - label: "false"
                      value: "false"
        vpc_access:
          name: vpc_access
          title: Vpc Access
          level: 1
          properties:
            egress:
              name: egress
              title: Egress
              subtext: Traffic VPC egress settings.
              enumValueLabels:
                - label: ALL_TRAFFIC
                  value: ALL_TRAFFIC
                - label: PRIVATE_RANGES_ONLY
                  value: PRIVATE_RANGES_ONLY
            connector:
              name: connector
              title: Connector
              subtext: VPC Access connector name.
              regexValidation: "^projects/(?:[a-z][a-z0-9-]*[a-z0-9]|[0-9]+)/locations/([a-z0-9-]+)/connectors/([a-z][a-z0-9-]*[a-z0-9])$"
              validation: Invalid connector name. It must be in the format projects/{project}/locations/{location}/connectors/{connector}
            network_interfaces:
              name: network_interfaces
              title: Network Interfaces
              subtext: Direct VPC egress settings. Currently only single network interface is supported.
              toggleUsingVariables:
                - variableName: vpc_access.connector
              properties:
                network:
                  name: network
                  title: Network
                  subtext: The VPC network that the Cloud Run resource will be able to send traffic to.
                  regexValidation: ^(projects\/[a-z0-9\-]+\/global\/networks\/[a-zA-Z0-9\-_]+|[a-zA-Z0-9\-_]+)$
                  validation: Network must be a valid network name or a full resource path.
                subnetwork:
                  name: subnetwork
                  title: Subnetwork
                  subtext: The VPC subnetwork that the Cloud Run resource will get IPs from. At least one of network or subnetwork must be specified. If both network and subnetwork are specified, the given VPC subnetwork must belong to the given VPC network. If subnetwork is not specified, the subnetwork with the same name with the network will be used.
                  regexValidation: ^(projects\/[a-z0-9\-]+\/regions\/[a-z0-9\-]+\/subnetworks\/[a-zA-Z0-9\-_]+|[a-zA-Z0-9\-_]+)$
                  validation: Subnetwork must be a valid subnetwork name or a full resource path.
                tags:
                  name: tags
                  title: Tags
                  regexValidation: "^[a-z][a-z0-9-]*$"
                  validation: Must start with a lowercase letter and contain only lowercase letters, numbers, and hyphens
          altDefaults:
            - type: ALTERNATE_TYPE_DC
              value:
                egress: ALL_TRAFFIC
                network_interfaces:
                  network: default
                  subnetwork: default
        node_selector:
          name: node_selector
          title: Node Selector
          level: 1
        gpu_zonal_redundancy_disabled:
          name: gpu_zonal_redundancy_disabled
          title: GPU Zonal Redundancy disabled
          altDefaults:
            - type: ALTERNATE_TYPE_DC
              value: false
    runtime:
      outputs:
        service_uri:
          visibility: VISIBILITY_ROOT
